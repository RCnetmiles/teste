<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RiskMap Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            overscroll-behavior: none; 
            touch-action: none; /* Disable browser zooming/scrolling globally */
        }
        .grid-cell {
            width: 40px;
            height: 40px;
        }
        /* Custom scrollbar for palette */
        .palette-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .palette-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fade-in 0.2s ease-out forwards;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.37.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body class="bg-gray-50 h-screen w-screen flex flex-col overflow-hidden font-sans select-none text-slate-800">

    <!-- HEADER -->
    <header class="flex items-center justify-between px-4 py-3 shadow-md z-30 shrink-0 bg-[#003366]">
        <div class="flex items-center gap-2">
            <div class="bg-white p-1 rounded-full text-xl">üß¨</div>
            <div>
                <h1 class="text-white font-bold text-lg leading-tight">RiskMap Builder</h1>
                <p class="text-blue-200 text-xs">Simulador de Biosseguran√ßa</p>
            </div>
        </div>
        <div id="score-badge" class="hidden px-2 py-1 rounded text-xs font-bold text-white">
            <!-- Score injected here -->
        </div>
    </header>

    <!-- MAIN CANVAS -->
    <main id="main-container" class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#F3F4F6] cursor-grab active:cursor-grabbing">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#003366 1px, transparent 1px); background-size: 20px 20px;">
        </div>

        <!-- Transform Container -->
        <div id="transform-container" class="bg-white shadow-xl relative transition-transform duration-75 ease-out origin-center will-change-transform"
             style="width: 800px; height: 800px; transform: scale(0.5);">
            
            <!-- The Grid -->
            <div id="lab-grid" class="grid w-full h-full border-4 border-gray-800"
                 style="grid-template-columns: repeat(20, 40px); grid-template-rows: repeat(20, 40px);">
                <!-- Cells generated by JS -->
            </div>
            
            <!-- Overlay lines -->
            <div class="absolute inset-0 pointer-events-none border border-gray-300 opacity-20"></div>
        </div>

        <!-- Hint -->
        <div id="hint" class="absolute top-4 bg-white/90 p-2 rounded shadow text-gray-600 text-sm animate-pulse pointer-events-none z-10">
            üëÜ Arraste para mover, pince para zoom
        </div>
    </main>

    <!-- CONTROLS & PALETTE -->
    <div class="shrink-0 z-20 flex flex-col bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        
        <!-- Top Controls -->
        <div class="px-4 py-2 flex flex-col gap-3 w-full max-w-md mx-auto">
            <div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                <label class="text-[#003366] font-bold text-sm">N√≠vel Biosseguran√ßa:</label>
                <select id="nb-select" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 block p-1 font-bold">
                    <option value="NB-1">NB-1</option>
                    <option value="NB-2">NB-2</option>
                    <option value="NB-3">NB-3</option>
                    <option value="NB-4">NB-4</option>
                </select>
            </div>

            <div class="flex gap-2 justify-between">
                <div class="flex gap-1 bg-white p-1 rounded-lg shadow-sm border border-gray-200">
                    <button id="btn-zoom-out" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-bold text-xl">-</button>
                    <button id="btn-zoom-in" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-bold text-xl">+</button>
                </div>
                <button id="btn-reset" class="px-4 h-10 flex items-center justify-center bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-bold text-sm">Limpar</button>
                <button id="btn-evaluate" class="flex-1 h-10 px-4 rounded-lg font-bold text-white shadow-md transition-all bg-[#FF8C00] hover:bg-[#e67e00] active:scale-95">
                    Avaliar Risco
                </button>
            </div>
        </div>

        <!-- Palette -->
        <div class="bg-white border-t-2 border-gray-200 w-full flex flex-col h-64 overflow-hidden">
            <div id="palette-container" class="flex-1 overflow-y-auto p-4 pb-20 palette-scroll">
                <h3 class="text-[#003366] font-bold mb-2 uppercase text-xs tracking-wider">Ferramentas</h3>
                
                <!-- Eraser -->
                <div class="mb-4">
                     <button id="tool-eraser" class="tool-btn flex items-center gap-3 w-full p-3 rounded-lg border-2 transition-all border-[#FF8C00] bg-orange-50 ring-2 ring-orange-200">
                        <span class="text-2xl">üßπ</span>
                        <div class="text-left">
                            <p class="font-bold text-gray-800">Borracha</p>
                            <p class="text-xs text-gray-500">Remover item</p>
                        </div>
                    </button>
                </div>

                <!-- Categories Container -->
                <div id="items-grid"></div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden flex flex-col max-h-[90vh]">
            <div id="modal-header" class="p-6 text-white text-center">
                <h2 id="modal-score" class="text-3xl font-bold mb-1">0/100</h2>
                <p id="modal-status" class="font-medium opacity-90">STATUS</p>
            </div>
            <div class="p-6 overflow-y-auto">
                <h3 class="text-[#003366] font-bold mb-3 border-b pb-2">Relat√≥rio de An√°lise</h3>
                <ul id="modal-feedback" class="space-y-3"></ul>
            </div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button id="btn-close-modal" class="bg-[#003366] text-white px-6 py-2 rounded-lg font-bold hover:bg-[#002244] transition-colors">Voltar ao Mapa</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        // --- CONSTANTS & DATA ---
        const GRID_SIZE = 20;
        const CELL_SIZE = 40;
        
        // Items Definition
        const LAB_ITEMS = [
            // Infrastructure
            { id: 'wall', name: 'Parede', category: 'INFRASTRUCTURE', icon: 'üß±', color: 'bg-gray-700', description: 'Bloqueia movimento.' },
            { id: 'door', name: 'Porta', category: 'INFRASTRUCTURE', icon: 'üö™', color: 'bg-yellow-100', description: 'Entrada e sa√≠da.' },
            { id: 'bench', name: 'Bancada', category: 'INFRASTRUCTURE', icon: '‚¨ú', color: 'bg-gray-300', description: 'Local para colocar amostras.' },
            // Equipment
            { id: 'fume_hood', name: 'Capela', category: 'EQUIPMENT', icon: 'üí®', color: 'bg-blue-200', description: 'Prote√ß√£o para qu√≠micos.' },
            { id: 'sink', name: 'Pia', category: 'EQUIPMENT', icon: 'üö∞', color: 'bg-cyan-100', description: 'Lavagem de m√£os.' },
            { id: 'waste_bio', name: 'Lixo Infect.', category: 'EQUIPMENT', icon: 'üóëÔ∏è', color: 'bg-red-100', description: 'Descarte biol√≥gico.' },
            { id: 'chair', name: 'Cadeira', category: 'EQUIPMENT', icon: 'ü™ë', color: 'bg-slate-200', description: 'Assento ergon√¥mico.' },
            { id: 'cabinet', name: 'Arm√°rio', category: 'EQUIPMENT', icon: 'üóÑÔ∏è', color: 'bg-amber-100', description: 'Armazenamento de materiais.' },
            // Samples
            { id: 'sample_chem', name: 'Qu√≠mico', category: 'SAMPLE', icon: 'üß™', color: 'bg-green-200', description: 'Reagente t√≥xico.' },
            { id: 'sample_bio_low', name: 'Bio (Baixo)', category: 'SAMPLE', icon: 'üß´', color: 'bg-yellow-200', description: 'Risco bio baixo.' },
            { id: 'sample_bio_high', name: 'Bio (Alto)', category: 'SAMPLE', icon: '‚ò£Ô∏è', color: 'bg-red-200', description: 'Risco bio alto.' },
            // Safety
            { id: 'shower', name: 'Chuveiro', category: 'SAFETY', icon: 'üöø', color: 'bg-green-100', description: 'Chuveiro de emerg√™ncia.' }
        ];

        // State
        let grid = new Array(GRID_SIZE * GRID_SIZE).fill(null); // Stores item objects or null
        let selectedToolId = null; // null = eraser
        let nbLevel = 'NB-1';
        let zoom = 0.5;
        let pan = { x: 0, y: 0 };
        let isEvaluating = false;

        // Interaction State
        let isDragging = false;
        let startX = 0, startY = 0;
        let lastTouch = null;
        let lastDist = null;

        // Elements
        const gridEl = document.getElementById('lab-grid');
        const containerEl = document.getElementById('transform-container');
        const mainEl = document.getElementById('main-container');
        const hintEl = document.getElementById('hint');
        const scoreBadge = document.getElementById('score-badge');
        
        // --- INITIALIZATION ---
        function init() {
            renderGridCells();
            renderPalette();
            updateTransform();
            
            // Events
            mainEl.addEventListener('touchstart', handleTouchStart, { passive: false });
            mainEl.addEventListener('touchmove', handleTouchMove, { passive: false });
            mainEl.addEventListener('touchend', handleTouchEnd);
            
            // Mouse fallbacks for desktop
            mainEl.addEventListener('mousedown', (e) => {
                isDragging = false;
                startX = e.clientX;
                startY = e.clientY;
                mainEl.style.cursor = 'grabbing';
                
                const onMouseMove = (moveEvent) => {
                    const dx = moveEvent.clientX - startX;
                    const dy = moveEvent.clientY - startY;
                    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) isDragging = true;
                    pan.x += dx;
                    pan.y += dy;
                    startX = moveEvent.clientX;
                    startY = moveEvent.clientY;
                    updateTransform();
                };
                
                const onMouseUp = () => {
                    mainEl.removeEventListener('mousemove', onMouseMove);
                    mainEl.removeEventListener('mouseup', onMouseUp);
                    mainEl.style.cursor = 'grab';
                };
                
                mainEl.addEventListener('mousemove', onMouseMove);
                mainEl.addEventListener('mouseup', onMouseUp);
            });

            // Button Listeners
            document.getElementById('btn-zoom-in').onclick = () => { zoom = Math.min(zoom + 0.1, 2.5); updateTransform(); };
            document.getElementById('btn-zoom-out').onclick = () => { zoom = Math.max(zoom - 0.1, 0.2); updateTransform(); };
            document.getElementById('btn-reset').onclick = handleReset;
            document.getElementById('btn-evaluate').onclick = handleEvaluate;
            document.getElementById('nb-select').onchange = (e) => nbLevel = e.target.value;
            document.getElementById('tool-eraser').onclick = () => selectTool(null);
            document.getElementById('btn-close-modal').onclick = () => document.getElementById('modal-overlay').classList.add('hidden');
        }

        // --- RENDERERS ---
        function renderGridCells() {
            gridEl.innerHTML = '';
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const div = document.createElement('div');
                div.id = `cell-${i}`;
                div.className = "border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none bg-white hover:bg-blue-50 transition-colors overflow-hidden grid-cell";
                
                // Click/Tap Logic
                // We use pointerup to handle both mouse and touch taps properly
                div.addEventListener('pointerup', (e) => {
                    // Only trigger if we weren't dragging the map
                    if (!isDragging) {
                        handleCellClick(i);
                    }
                });

                gridEl.appendChild(div);
            }
        }

        function updateGridCell(index) {
            const cell = grid[index];
            const div = document.getElementById(`cell-${index}`);
            if (cell) {
                div.className = `border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none transition-colors overflow-hidden grid-cell ${cell.color}`;
                div.innerText = cell.icon;
            } else {
                div.className = "border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none bg-white hover:bg-blue-50 transition-colors overflow-hidden grid-cell";
                div.innerText = '';
            }
            
            // Update hint visibility
            const isEmpty = grid.every(c => c === null);
            hintEl.style.display = isEmpty ? 'block' : 'none';
        }

        function renderPalette() {
            const container = document.getElementById('items-grid');
            const categories = ['INFRASTRUCTURE', 'EQUIPMENT', 'SAMPLE', 'SAFETY'];
            
            categories.forEach(cat => {
                const header = document.createElement('h3');
                header.className = "text-gray-400 font-bold mb-2 text-xs uppercase tracking-wider mt-4";
                header.innerText = cat;
                container.appendChild(header);

                const gridDiv = document.createElement('div');
                gridDiv.className = "grid grid-cols-2 gap-3";
                
                LAB_ITEMS.filter(i => i.category === cat).forEach(item => {
                    const btn = document.createElement('button');
                    btn.id = `tool-${item.id}`;
                    btn.className = "tool-btn flex flex-col items-center p-3 rounded-lg border-2 transition-all active:scale-95 border-gray-100 bg-white hover:border-gray-300 shadow-sm";
                    btn.innerHTML = `<span class="text-3xl mb-1">${item.icon}</span><span class="text-sm font-semibold text-gray-700">${item.name}</span>`;
                    btn.onclick = () => selectTool(item.id);
                    gridDiv.appendChild(btn);
                });
                container.appendChild(gridDiv);
            });
        }

        function selectTool(id) {
            selectedToolId = id;
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.className = "tool-btn flex flex-col items-center p-3 rounded-lg border-2 transition-all active:scale-95 border-gray-100 bg-white hover:border-gray-300 shadow-sm";
                // Restore eraser specific class if needed, or generic
                if(btn.id === 'tool-eraser') {
                     btn.className = "tool-btn flex items-center gap-3 w-full p-3 rounded-lg border-2 transition-all border-gray-200 bg-gray-50 hover:bg-gray-100";
                }
            });

            if (id === null) {
                const btn = document.getElementById('tool-eraser');
                btn.className = "tool-btn flex items-center gap-3 w-full p-3 rounded-lg border-2 transition-all border-[#FF8C00] bg-orange-50 ring-2 ring-orange-200";
            } else {
                const btn = document.getElementById(`tool-${id}`);
                if(btn) btn.className = "tool-btn flex flex-col items-center p-3 rounded-lg border-2 transition-all active:scale-95 border-[#003366] bg-blue-50 ring-2 ring-blue-200 shadow-md";
            }
        }

        function updateTransform() {
            containerEl.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
        }

        // --- ACTIONS ---
        function handleCellClick(index) {
            if (selectedToolId === null) {
                grid[index] = null;
            } else {
                const item = LAB_ITEMS.find(i => i.id === selectedToolId);
                grid[index] = item;
            }
            updateGridCell(index);
        }

        function handleReset() {
            if (confirm('Tem certeza que deseja limpar o mapa?')) {
                grid = new Array(GRID_SIZE * GRID_SIZE).fill(null);
                for(let i=0; i<grid.length; i++) updateGridCell(i);
                
                // Reset View
                pan = {x: 0, y: 0};
                zoom = 0.5;
                updateTransform();
                
                // Reset Score
                scoreBadge.classList.add('hidden');
            }
        }

        // --- TOUCH LOGIC ---
        function getDistance(t1, t2) {
            return Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
        }

        function handleTouchStart(e) {
            isDragging = false;
            if (e.touches.length === 1) {
                lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            } else if (e.touches.length === 2) {
                lastDist = getDistance(e.touches[0], e.touches[1]);
            }
        }

        function handleTouchMove(e) {
            e.preventDefault(); // Stop browser zoom/scroll
            if (e.touches.length === 1 && lastTouch) {
                const dx = e.touches[0].clientX - lastTouch.x;
                const dy = e.touches[0].clientY - lastTouch.y;
                if (Math.abs(dx) > 2 || Math.abs(dy) > 2) isDragging = true;
                pan.x += dx;
                pan.y += dy;
                lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                updateTransform();
            } else if (e.touches.length === 2 && lastDist) {
                const newDist = getDistance(e.touches[0], e.touches[1]);
                const scaleFactor = newDist / lastDist;
                zoom = Math.min(Math.max(zoom * scaleFactor, 0.2), 3.0);
                lastDist = newDist;
                isDragging = true;
                updateTransform();
            }
        }

        function handleTouchEnd(e) {
            lastTouch = null;
            lastDist = null;
            // Short delay to prevent click event overlap if needed, 
            // but isDragging flag handles it mostly.
        }

        // --- GEMINI AI ---
        async function handleEvaluate() {
            const btn = document.getElementById('btn-evaluate');
            if (isEvaluating) return;

            const apiKey = process.env.API_KEY;
            if (!apiKey) {
                alert("Erro: API_KEY n√£o encontrada.");
                return;
            }

            isEvaluating = true;
            btn.innerText = "Avaliando...";
            btn.classList.add('bg-gray-400', 'cursor-not-allowed');
            
            try {
                const ai = new GoogleGenAI({ apiKey });
                
                // 1. Generate ASCII Map
                let visualMap = "";
                const legend = [];
                const usedItems = new Set();
                
                for (let y = 0; y < GRID_SIZE; y++) {
                    let rowStr = "| ";
                    for (let x = 0; x < GRID_SIZE; x++) {
                        const index = y * GRID_SIZE + x;
                        const item = grid[index];
                        if (item) {
                            rowStr += `${item.icon} `;
                            if (!usedItems.has(item.name)) {
                                usedItems.add(item.name);
                                legend.push(`${item.icon} = ${item.name}`);
                            }
                        } else {
                            rowStr += ".  ";
                        }
                    }
                    visualMap += rowStr + "|\n";
                }

                const prompt = `
                    Atue como um Especialista S√™nior em Biosseguran√ßa. Avalie este laborat√≥rio:
                    
                    NB: ${nbLevel}
                    Dimens√£o: ${GRID_SIZE}x${GRID_SIZE}
                    
                    MAPA (Vista Superior):
                    Legenda: . = Vazio, üß± = Parede, üö™ = Porta, ü™ë = Cadeira, üóÑÔ∏è = Arm√°rio
                    Outros: ${legend.join(", ")}
                    
                    ${visualMap}
                    
                    REGRAS:
                    1. NB-3/NB-4 EXIGEM Antec√¢mara (√°rea fechada com 2 portas entre corredor e lab). Sem isso = INSEGURO.
                    2. Amostras (üß™, ‚ò£Ô∏è) representam armazenamento seguro. Avalie se o local √© adequado (bancada/arm√°rio) e n√£o bloqueia passagem.
                    3. Fluxo: Portas acess√≠veis, Chuveiro/Lava-olhos desobstru√≠dos.
                    
                    SA√çDA JSON:
                    { "score": 0-100, "isSafe": boolean, "feedback": ["3-5 dicas curtas"] }
                `;

                const response = await ai.models.generateContent({
                    model: 'gemini-3-flash-preview',
                    contents: prompt,
                    config: {
                        responseMimeType: 'application/json',
                        responseSchema: {
                            type: Type.OBJECT,
                            properties: {
                                score: { type: Type.INTEGER },
                                feedback: { type: Type.ARRAY, items: { type: Type.STRING } },
                                isSafe: { type: Type.BOOLEAN },
                            },
                            required: ["score", "feedback", "isSafe"],
                        },
                    }
                });
                
                const result = JSON.parse(response.text);
                showResult(result);

            } catch (err) {
                console.error(err);
                alert("Erro na avalia√ß√£o. Tente novamente.");
            } finally {
                isEvaluating = false;
                btn.innerText = "Avaliar Risco";
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function showResult(result) {
            const modal = document.getElementById('modal-overlay');
            const header = document.getElementById('modal-header');
            const score = document.getElementById('modal-score');
            const status = document.getElementById('modal-status');
            const list = document.getElementById('modal-feedback');
            
            score.innerText = `${result.score}/100`;
            status.innerText = result.isSafe ? 'LABORAT√ìRIO SEGURO' : 'RISCOS DETECTADOS';
            header.className = `p-6 text-white text-center ${result.isSafe ? 'bg-green-600' : 'bg-red-600'}`;
            
            list.innerHTML = '';
            result.feedback.forEach(tip => {
                const li = document.createElement('li');
                li.className = "flex gap-3 text-sm text-gray-700 bg-gray-50 p-2 rounded";
                li.innerHTML = `<span class="text-xl shrink-0">${result.isSafe ? '‚úÖ' : '‚ö†Ô∏è'}</span><span>${tip}</span>`;
                list.appendChild(li);
            });
            
            modal.classList.remove('hidden');

            // Update Badge
            scoreBadge.innerText = `Score: ${result.score}`;
            scoreBadge.className = `px-2 py-1 rounded text-xs font-bold text-white block ${result.isSafe ? 'bg-green-500' : 'bg-red-500'}`;
            scoreBadge.classList.remove('hidden');
        }

        // Run
        init();
    </script>
</body>
</html>
