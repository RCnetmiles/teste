<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LabSafe - Criador de Mapas de Risco</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --panel-bg: #f8f9fa;
            --border: #bdc3c7;
            
            /* Cores de Risco (Padr√£o Brasileiro) */
            --risk-bio: #8d6e63; /* Marrom */
            --risk-chem: #e74c3c; /* Vermelho */
            --risk-phys: #27ae60; /* Verde */
            --risk-ergo: #f1c40f; /* Amarelo */
            --risk-acci: #2980b9; /* Azul (Acidentes/Mec√¢nico - opcional, mas comum) */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ddd;
            overflow: hidden; /* App-like feel */
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- UI Layout --- */
        header {
            background-color: var(--primary);
            color: white;
            padding: 0 15px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        h1 { font-size: 1.2rem; margin: 0; display: flex; align-items: center; gap: 10px; }
        
        .main-container {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* --- Toolbar (Left) --- */
        .toolbar {
            width: 60px;
            background-color: var(--primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
            gap: 10px;
            z-index: 90;
            transition: transform 0.3s ease;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            position: relative;
        }

        .tool-btn:hover { background: rgba(255,255,255,0.3); }
        .tool-btn.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        
        /* Tooltip */
        .tool-btn::after {
            content: attr(data-title);
            position: absolute;
            left: 50px;
            background: #333;
            color: white;
            padding: 4px 8px;
            font-size: 0.8rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .tool-btn:hover::after { opacity: 1; }

        /* --- Canvas Area --- */
        #canvas-wrapper {
            flex: 1;
            background-color: #95a5a6;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }
        
        canvas {
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: block;
            touch-action: none; /* Critical for custom gestures */
        }

        /* --- Properties Panel (Right) --- */
        .properties-panel {
            width: 250px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border);
            padding: 15px;
            overflow-y: auto;
            z-index: 90;
            transition: transform 0.3s ease;
        }

        .panel-section { margin-bottom: 20px; }
        .panel-title { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #ddd; padding-bottom: 5px; color: var(--dark); }
        
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 0.9rem; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
        button.action-btn {
            width: 100%; padding: 8px; margin-top: 5px; cursor: pointer;
            background: var(--accent); color: white; border: none; border-radius: 4px;
        }
        button.danger-btn { background: #e74c3c; }

        /* --- Mobile Overlays & Responsiveness --- */
        .hamburger { display: none; background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        .orientation-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; color: white;
            display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center;
        }

        /* Zoom Controls floating */
        .zoom-controls {
            position: absolute; bottom: 20px; right: 280px; /* offset for panel */
            display: flex; gap: 5px; z-index: 80;
        }
        .zoom-btn { width: 30px; height: 30px; border: none; background: white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; }

        /* Media Queries */
        @media (max-width: 768px) {
            .hamburger { display: block; }
            
            .toolbar {
                position: absolute; left: 0; top: 0; bottom: 0;
                transform: translateX(-100%);
            }
            .toolbar.open { transform: translateX(0); }

            .properties-panel {
                position: absolute; right: 0; top: 0; bottom: 0;
                transform: translateX(100%);
                width: 280px;
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            }
            .properties-panel.open { transform: translateX(0); }

            .zoom-controls { right: 20px; bottom: 20px; }
        }

        @media screen and (orientation: portrait) and (max-width: 600px) {
            .orientation-warning { display: flex; }
        }

        /* Print Styling */
        @media print {
            header, .toolbar, .properties-panel, .zoom-controls { display: none !important; }
            body, .main-container { height: auto; overflow: visible; background: white; }
            #canvas-wrapper { overflow: visible; background: white; }
            canvas { box-shadow: none; border: 1px solid #000; max-width: 100%; }
            
            /* Add legend specifically for print */
            #print-legend { display: block !important; margin-top: 20px; page-break-inside: avoid; }
        }
        #print-legend { display: none; padding: 20px; font-family: sans-serif; }
        .legend-item { display: inline-flex; align-items: center; margin-right: 20px; margin-bottom: 10px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; border: 1px solid #ccc;}
    </style>
</head>
<body>

    <div class="orientation-warning" id="orientationWarning">
        <div style="font-size: 3rem;">‚Üª</div>
        <p>Gire seu dispositivo para modo paisagem<br>para melhor experi√™ncia de desenho.</p>
        <button style="margin-top:20px; padding:10px 20px;" onclick="document.getElementById('orientationWarning').style.display='none'">Ignorar</button>
    </div>

    <header>
        <button class="hamburger" id="menuToggle">‚ò∞</button>
        <h1>üî¨ LabSafe <span style="font-size:0.8rem; opacity:0.8; font-weight:normal;">| Criador de Mapa de Risco</span></h1>
        <div>
            <button onclick="app.saveJSON()" class="tool-btn" style="width:auto; padding:0 10px; font-size:0.9rem;">üíæ Salvar</button>
        </div>
    </header>

    <div class="main-container">
        <div class="toolbar" id="mainToolbar">
            <button class="tool-btn active" data-tool="select" data-title="Selecionar (V)" onclick="app.setTool('select')">üëÜ</button>
            <div style="width: 80%; height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
            <button class="tool-btn" data-tool="wall" data-title="Parede (W)" onclick="app.setTool('wall')">ü™ú</button>
            <button class="tool-btn" data-tool="door" data-title="Porta (D)" onclick="app.setTool('door')">üö™</button>
            <button class="tool-btn" data-tool="bench" data-title="Bancada (B)" onclick="app.setTool('bench')">üî≤</button>
            <button class="tool-btn" data-tool="hood" data-title="Capela/Equip (H)" onclick="app.setTool('hood')">üí®</button>
            <div style="width: 80%; height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
            <button class="tool-btn" data-tool="risk" data-title="Adicionar Risco (R)" onclick="app.setTool('risk')">‚ö†Ô∏è</button>
            <div style="flex:1"></div>
            <button class="tool-btn" data-tool="properties" onclick="app.togglePanel()" id="mobilePropBtn" style="display:none;">‚öôÔ∏è</button>
        </div>

        <div id="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="app.zoom(1.1)">+</button>
                <button class="zoom-btn" onclick="app.resetZoom()">1:1</button>
                <button class="zoom-btn" onclick="app.zoom(0.9)">-</button>
            </div>
        </div>

        <div class="properties-panel" id="propPanel">
            <div class="panel-section">
                <div class="panel-title">Projeto</div>
                <div class="form-group">
                    <label>Nome do Laborat√≥rio</label>
                    <input type="text" id="labName" value="Laborat√≥rio 01">
                </div>
                <button class="action-btn" onclick="app.exportImage()">üì∏ Exportar Imagem (PNG)</button>
                <button class="action-btn" onclick="app.exportPDF()">üìÑ Imprimir / PDF</button>
                <input type="file" id="fileInput" style="display:none" onchange="app.loadJSON(this)">
                <button class="action-btn" style="background:var(--primary); margin-top:5px" onclick="document.getElementById('fileInput').click()">üìÇ Carregar Projeto</button>
            </div>

            <hr>

            <div id="selectionProperties" style="display:none;">
                <div class="panel-title">Propriedades do Item</div>
                
                <div class="form-group">
                    <label>R√≥tulo (Opcional)</label>
                    <input type="text" id="propLabel" oninput="app.updateSelection()">
                </div>

                <div id="riskProps" style="display:none;">
                    <div class="form-group">
                        <label>Tipo de Risco</label>
                        <select id="riskType" onchange="app.updateSelection()">
                            <option value="bio">Biol√≥gico (Marrom)</option>
                            <option value="chem">Qu√≠mico (Vermelho)</option>
                            <option value="phys">F√≠sico (Verde)</option>
                            <option value="ergo">Ergon√¥mico (Amarelo)</option>
                            <option value="acci">Acidentes (Azul)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Intensidade / Tamanho</label>
                        <select id="riskSize" onchange="app.updateSelection()">
                            <option value="20">Pequeno</option>
                            <option value="35">M√©dio</option>
                            <option value="50">Grande</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>N√≠vel Biosseguran√ßa</label>
                        <select id="riskNB" onchange="app.updateSelection()">
                            <option value="">Nenhum</option>
                            <option value="NB1">NB-1</option>
                            <option value="NB2">NB-2</option>
                            <option value="NB3">NB-3</option>
                            <option value="NB4">NB-4</option>
                        </select>
                    </div>
                </div>

                <button class="danger-btn" onclick="app.deleteSelection()">üóëÔ∏è Excluir Item</button>
            </div>
            
            <div id="noSelectionMsg" style="color:#777; font-style:italic; padding:10px 0;">
                Selecione um item no mapa para editar suas propriedades.
            </div>
        </div>
    </div>

    <div id="print-legend">
        <h3>Legenda de Riscos</h3>
        <div class="legend-item"><div class="legend-color" style="background:var(--risk-bio)"></div>Biol√≥gico</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--risk-chem)"></div>Qu√≠mico</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--risk-phys)"></div>F√≠sico</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--risk-ergo)"></div>Ergon√¥mico</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--risk-acci)"></div>Acidentes</div>
        <p>Gerado por LabSafe Digital - <span id="printDate"></span></p>
    </div>

<script>
/**
 * LabSafe Core Logic
 * Uma aplica√ß√£o vanilla JS estruturada para desenhar mapas de risco.
 */
const app = (function() {
    // --- Configura√ß√µes e Estado ---
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('canvas-wrapper');
    
    // Cores
    const colors = {
        bio: '#8d6e63', chem: '#e74c3c', phys: '#27ae60', ergo: '#f1c40f', acci: '#2980b9',
        wall: '#34495e', selection: '#3498db'
    };

    let state = {
        tool: 'select', // select, wall, door, bench, hood, risk
        elements: [], // Array de objetos {id, type, x, y, ...}
        selection: null, // ID do item selecionado
        scale: 1,
        panX: 0,
        panY: 0,
        isDragging: false,
        isDrawing: false,
        lastX: 0,
        lastY: 0,
        tempShape: null, // Shape sendo desenhado no momento
        touchDistStart: 0 // Para pinch zoom
    };

    // --- Sistema de Renderiza√ß√£o ---
    function resize() {
        canvas.width = wrapper.clientWidth;
        canvas.height = wrapper.clientHeight;
        render();
    }

    function toWorld(screenX, screenY) {
        return {
            x: (screenX - state.panX) / state.scale,
            y: (screenY - state.panY) / state.scale
        };
    }

    function toScreen(worldX, worldY) {
        return {
            x: (worldX * state.scale) + state.panX,
            y: (worldY * state.scale) + state.panY
        };
    }

    function render() {
        // Limpar
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Grid Fundo
        drawGrid();

        ctx.save();
        ctx.translate(state.panX, state.panY);
        ctx.scale(state.scale, state.scale);

        // Desenhar Elementos
        [...state.elements, state.tempShape].forEach(el => {
            if(!el) return;
            drawElement(el);
        });

        // Desenhar Sele√ß√£o (Borda)
        if(state.selection) {
            const el = state.elements.find(e => e.id === state.selection);
            if(el) drawSelectionOutline(el);
        }

        ctx.restore();
    }

    function drawGrid() {
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        const gridSize = 50 * state.scale;
        const offsetX = state.panX % gridSize;
        const offsetY = state.panY % gridSize;

        ctx.beginPath();
        for(let x = offsetX; x < canvas.width; x += gridSize) {
            ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
        }
        for(let y = offsetY; y < canvas.height; y += gridSize) {
            ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
        }
        ctx.stroke();
    }

    function drawElement(el) {
        ctx.fillStyle = '#ccc';
        ctx.strokeStyle = colors.wall;
        ctx.lineWidth = 2;
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        if(el.type === 'wall') {
            ctx.beginPath();
            ctx.moveTo(el.x, el.y);
            ctx.lineTo(el.ex, el.ey);
            ctx.stroke();
        } 
        else if (el.type === 'bench') {
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(el.x, el.y, el.w, el.h);
            ctx.strokeRect(el.x, el.y, el.w, el.h);
            if(el.label) { ctx.fillStyle='#555'; ctx.fillText(el.label, el.x + el.w/2, el.y + el.h/2); }
        }
        else if (el.type === 'hood') {
            ctx.fillStyle = '#d5dbdb';
            ctx.fillRect(el.x, el.y, el.w, el.h);
            ctx.strokeRect(el.x, el.y, el.w, el.h);
            // Simbolo de X
            ctx.beginPath(); ctx.moveTo(el.x, el.y); ctx.lineTo(el.x+el.w, el.y+el.h); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(el.x+el.w, el.y); ctx.lineTo(el.x, el.y+el.h); ctx.stroke();
            if(el.label) { ctx.fillStyle='black'; ctx.fillText(el.label, el.x + el.w/2, el.y - 10); }
        }
        else if (el.type === 'door') {
            // Desenhar arco de porta simples
            ctx.beginPath();
            ctx.arc(el.x, el.y, el.w, 0, -Math.PI/2, true);
            ctx.stroke();
            ctx.beginPath(); ctx.moveTo(el.x, el.y); ctx.lineTo(el.x, el.y - el.w); ctx.stroke(); // Linha reta
            ctx.beginPath(); ctx.moveTo(el.x, el.y); ctx.lineTo(el.x + el.w, el.y); ctx.stroke(); // Base
        }
        else if (el.type === 'risk') {
            const r = parseInt(el.size) || 20;
            ctx.beginPath();
            ctx.arc(el.x, el.y, r, 0, Math.PI * 2);
            ctx.fillStyle = colors[el.riskType] || '#999';
            ctx.globalAlpha = 0.7;
            ctx.fill();
            ctx.globalAlpha = 1.0;
            ctx.strokeStyle = '#fff';
            ctx.stroke();
            
            // Texto NB
            if(el.nb) {
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.fillText(el.nb, el.x, el.y);
            }
        }
    }

    function drawSelectionOutline(el) {
        ctx.strokeStyle = colors.selection;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        
        let pad = 5;
        if(el.type === 'wall') {
            // Simplifica√ß√£o para linha
            ctx.beginPath(); ctx.moveTo(el.x, el.y); ctx.lineTo(el.ex, el.ey); ctx.stroke();
        } else if (el.type === 'risk') {
            let r = parseInt(el.size) + pad;
            ctx.strokeRect(el.x - r, el.y - r, r*2, r*2);
        } else {
            ctx.strokeRect(el.x - pad, el.y - pad, el.w + pad*2, el.h + pad*2);
        }
        ctx.setLineDash([]);
    }

    // --- L√≥gica de Ferramentas ---
    function setTool(toolName) {
        state.tool = toolName;
        // Atualiza UI
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`[data-tool="${toolName}"]`).classList.add('active');
        state.selection = null;
        updatePropPanel();
        render();
    }

    function createId() { return Math.random().toString(36).substr(2, 9); }

    // --- Input Handling ---
    function handleStart(x, y) {
        const world = toWorld(x, y);
        state.lastX = x; 
        state.lastY = y;

        if (state.tool === 'select') {
            // Hit testing b√°sico
            const hit = state.elements.slice().reverse().find(el => hitTest(el, world.x, world.y));
            if(hit) {
                state.selection = hit.id;
                state.isDragging = true;
                updatePropPanel();
            } else {
                state.selection = null;
                state.isDragging = true; // Pan
                updatePropPanel();
            }
        } else {
            // Iniciar desenho
            state.isDrawing = true;
            if(state.tool === 'wall') {
                state.tempShape = { type: 'wall', x: world.x, y: world.y, ex: world.x, ey: world.y };
            } else if (state.tool === 'bench' || state.tool === 'hood') {
                state.tempShape = { type: state.tool, x: world.x, y: world.y, w: 0, h: 0 };
            }
        }
        render();
    }

    function handleMove(x, y) {
        const world = toWorld(x, y);
        
        if (state.tool === 'select') {
            if(state.isDragging) {
                if(state.selection) {
                    // Mover Elemento
                    const el = state.elements.find(e => e.id === state.selection);
                    const dx = (x - state.lastX) / state.scale;
                    const dy = (y - state.lastY) / state.scale;
                    el.x += dx; el.y += dy;
                    if(el.type === 'wall') { el.ex += dx; el.ey += dy; }
                } else {
                    // Pan Canvas
                    state.panX += x - state.lastX;
                    state.panY += y - state.lastY;
                }
            }
        } else if (state.isDrawing && state.tempShape) {
            if(state.tool === 'wall') {
                state.tempShape.ex = world.x;
                state.tempShape.ey = world.y;
            } else if (['bench', 'hood'].includes(state.tool)) {
                state.tempShape.w = world.x - state.tempShape.x;
                state.tempShape.h = world.y - state.tempShape.y;
            }
        }
        
        state.lastX = x;
        state.lastY = y;
        render();
    }

    function handleEnd() {
        if(state.isDrawing && state.tempShape) {
            // Finalizar forma
            // Normalizar ret√¢ngulos (largura negativa)
            if(state.tempShape.w < 0) { state.tempShape.x += state.tempShape.w; state.tempShape.w *= -1; }
            if(state.tempShape.h < 0) { state.tempShape.y += state.tempShape.h; state.tempShape.h *= -1; }
            
            // Adicionar apenas se tiver tamanho m√≠nimo
            if(Math.abs(state.tempShape.w) > 5 || Math.abs(state.tempShape.h) > 5 || state.tempShape.type === 'wall') {
                state.tempShape.id = createId();
                state.elements.push(state.tempShape);
            }
        } else if (state.tool === 'risk' && !state.isDragging && !state.isDrawing) {
            // Click to add risk
            const world = toWorld(state.lastX, state.lastY);
            state.elements.push({
                id: createId(),
                type: 'risk',
                x: world.x,
                y: world.y,
                size: 35,
                riskType: 'bio',
                nb: ''
            });
            // Auto selecionar novo risco
            state.selection = state.elements[state.elements.length-1].id;
            setTool('select');
        } else if (state.tool === 'door' && !state.isDragging) {
             const world = toWorld(state.lastX, state.lastY);
             state.elements.push({
                id: createId(),
                type: 'door',
                x: world.x,
                y: world.y,
                w: 40, h: 40 // raio
            });
            setTool('select');
        }

        state.isDragging = false;
        state.isDrawing = false;
        state.tempShape = null;
        render();
    }

    function hitTest(el, x, y) {
        if(el.type === 'risk') {
            const r = parseInt(el.size);
            const dist = Math.sqrt((x-el.x)**2 + (y-el.y)**2);
            return dist <= r;
        }
        if(el.type === 'wall') {
            // Dist√¢ncia ponto a segmento
            const A = x - el.x; const B = y - el.y;
            const C = el.ex - el.x; const D = el.ey - el.y;
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            let param = -1;
            if (len_sq != 0) param = dot / len_sq;
            let xx, yy;
            if (param < 0) { xx = el.x; yy = el.y; }
            else if (param > 1) { xx = el.ex; yy = el.ey; }
            else { xx = el.x + param * C; yy = el.y + param * D; }
            const dx = x - xx; const dy = y - yy;
            return Math.sqrt(dx * dx + dy * dy) < 10;
        }
        // Rects (Bench, Hood, Door bbox)
        let w = el.w; let h = el.h;
        if(el.type === 'door') { w = el.w; h = el.w; } // Aproxima√ß√£o
        return (x >= el.x && x <= el.x + w && y >= el.y && y <= el.y + h);
    }

    // --- UI Update & Propriedades ---
    function updatePropPanel() {
        const panel = document.getElementById('selectionProperties');
        const empty = document.getElementById('noSelectionMsg');
        
        if(!state.selection) {
            panel.style.display = 'none';
            empty.style.display = 'block';
            return;
        }

        panel.style.display = 'block';
        empty.style.display = 'none';

        const el = state.elements.find(e => e.id === state.selection);
        
        // Populate
        document.getElementById('propLabel').value = el.label || '';
        
        const riskProps = document.getElementById('riskProps');
        if(el.type === 'risk') {
            riskProps.style.display = 'block';
            document.getElementById('riskType').value = el.riskType;
            document.getElementById('riskSize').value = el.size;
            document.getElementById('riskNB').value = el.nb || '';
        } else {
            riskProps.style.display = 'none';
        }
    }

    function updateSelection() {
        const el = state.elements.find(e => e.id === state.selection);
        if(!el) return;

        el.label = document.getElementById('propLabel').value;
        if(el.type === 'risk') {
            el.riskType = document.getElementById('riskType').value;
            el.size = document.getElementById('riskSize').value;
            el.nb = document.getElementById('riskNB').value;
        }
        render();
    }

    function deleteSelection() {
        if(state.selection && confirm('Deseja excluir este item?')) {
            state.elements = state.elements.filter(e => e.id !== state.selection);
            state.selection = null;
            updatePropPanel();
            render();
        }
    }

    // --- Persist√™ncia e Exporta√ß√£o ---
    function saveJSON() {
        const data = {
            version: "1.0",
            timestamp: new Date().toISOString(),
            labName: document.getElementById('labName').value,
            elements: state.elements
        };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `MapaRisco_${data.labName}.json`;
        a.click();
    }

    function loadJSON(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                state.elements = data.elements;
                if(data.labName) document.getElementById('labName').value = data.labName;
                state.selection = null;
                render();
                alert('Projeto carregado com sucesso!');
            } catch(err) {
                alert('Erro ao ler arquivo: ' + err);
            }
        };
        reader.readAsText(file);
    }

    function exportImage() {
        // Redesenhar sem grid para exporta√ß√£o limpa
        const tempCanvas = document.createElement('canvas');
        // Calcular bounding box do desenho para n√£o exportar tudo
        // Por simplicidade, exportamos o tamanho atual do canvas, mas sem zoom
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tCtx = tempCanvas.getContext('2d');
        
        tCtx.fillStyle = 'white';
        tCtx.fillRect(0,0, tempCanvas.width, tempCanvas.height);
        
        // Simular render no temp
        // Para uma exporta√ß√£o perfeita, idealmente resetariamos o Pan/Scale
        // Aqui faremos "o que se v√™ √© o que se exporta"
        tCtx.drawImage(canvas, 0, 0);
        
        const link = document.createElement('a');
        link.download = `Mapa_${document.getElementById('labName').value}.png`;
        link.href = tempCanvas.toDataURL();
        link.click();
    }

    function exportPDF() {
        document.getElementById('printDate').innerText = new Date().toLocaleDateString();
        // Centraliza a visualiza√ß√£o antes de imprimir
        const oldScale = state.scale;
        const oldPanX = state.panX;
        // Tenta enquadrar (simples)
        state.scale = Math.min(canvas.width / 1000, canvas.height / 800); // Zoom out um pouco
        state.panX = 50;
        state.panY = 50;
        render();
        
        window.print();
        
        // Restaura
        state.scale = oldScale;
        state.panX = oldPanX;
        render();
    }

    // --- Event Listeners Init ---
    canvas.addEventListener('mousedown', e => handleStart(e.offsetX, e.offsetY));
    canvas.addEventListener('mousemove', e => {
        if(e.buttons === 1) handleMove(e.offsetX, e.offsetY);
    });
    canvas.addEventListener('mouseup', handleEnd);

    // Touch Events
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        if(e.touches.length === 2) {
            // Pinch start
            state.touchDistStart = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
        } else {
            const rect = canvas.getBoundingClientRect();
            handleStart(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if(e.touches.length === 2) {
            // Pinch Zoom Logic
            const dist = Math.hypot(
                e.touches[0].pageX - e.touches[1].pageX,
                e.touches[0].pageY - e.touches[1].pageY
            );
            if(state.touchDistStart > 0) {
                const delta = dist / state.touchDistStart;
                state.scale *= delta;
                state.touchDistStart = dist;
                render();
            }
        } else {
            const rect = canvas.getBoundingClientRect();
            handleMove(e.touches[0].clientX - rect.left, e.touches[0].clientY - rect.top);
        }
    }, {passive: false});

    canvas.addEventListener('touchend', e => {
        if(e.touches.length === 0) handleEnd();
    });

    // Window Resize
    window.addEventListener('resize', resize);
    
    // Zoom Wheel
    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        state.scale *= delta;
        render();
    });

    // Mobile Menus
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('mainToolbar').classList.toggle('open');
        document.getElementById('propPanel').classList.remove('open');
    });

    document.getElementById('mobilePropBtn').addEventListener('click', () => {
        document.getElementById('propPanel').classList.toggle('open');
        document.getElementById('mainToolbar').classList.remove('open');
    });

    // Init
    setTimeout(resize, 100);

    // Public API
    return {
        setTool,
        updateSelection,
        deleteSelection,
        saveJSON,
        loadJSON,
        exportImage,
        exportPDF,
        zoom: (f) => { state.scale *= f; render(); },
        resetZoom: () => { state.scale = 1; state.panX=0; state.panY=0; render(); },
        togglePanel: () => document.getElementById('propPanel').classList.toggle('open')
    };
})();
</script>
</body>
</html>
