<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Criador de Mapa de Risco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { 
            overscroll-behavior: none; 
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
        }
        .grid-cell {
            width: 40px;
            height: 40px;
        }
        .palette-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .palette-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        /* Risk Circle Styles */
        .risk-circle {
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.85;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            pointer-events: none; /* Let clicks pass through to cell handler */
            z-index: 20;
        }
        .risk-small { width: 15px; height: 15px; }
        .risk-medium { width: 25px; height: 25px; }
        .risk-large { width: 35px; height: 35px; }
        
        /* Animation for Reset */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-animation {
            animation: shake 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 h-screen w-screen flex flex-col overflow-hidden font-sans text-slate-800">

    <!-- HEADER -->
    <header class="flex items-center justify-between px-4 py-3 shadow-md z-30 shrink-0 bg-[#003366]">
        <div class="flex items-center gap-2">
            <div class="bg-white p-1 rounded-full text-xl">üó∫Ô∏è</div>
            <div>
                <h1 class="text-white font-bold text-lg leading-tight">RiskMap Creator</h1>
                <p class="text-blue-200 text-xs">Desenhe e Legende seu Mapa</p>
            </div>
        </div>
        <button id="btn-download" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold transition-colors shadow-sm active:scale-95">
            <span>üì∑</span> Baixar
        </button>
    </header>

    <!-- MAIN CANVAS -->
    <main id="main-container" class="flex-1 relative overflow-hidden flex items-center justify-center bg-[#F3F4F6] cursor-grab active:cursor-grabbing">
        <!-- Background Pattern -->
        <div class="absolute inset-0 opacity-10 pointer-events-none" 
             style="background-image: radial-gradient(#003366 1px, transparent 1px); background-size: 20px 20px;">
        </div>

        <!-- Transform Container -->
        <div id="transform-container" class="bg-white shadow-xl relative transition-transform duration-75 ease-out origin-center will-change-transform"
             style="width: 800px; height: 800px; transform: scale(0.5);">
            
            <!-- Layer 1: Infrastructure Grid -->
            <div id="lab-grid" class="grid w-full h-full border-4 border-gray-800 absolute inset-0 z-0"
                 style="grid-template-columns: repeat(20, 40px); grid-template-rows: repeat(20, 40px);">
                <!-- Cells generated by JS -->
            </div>

            <!-- Layer 2: Risk Circles Overlay -->
            <div id="risk-layer" class="w-full h-full absolute inset-0 z-10 pointer-events-none">
                <!-- Risk circles injected here via JS -->
            </div>
            
            <!-- Overlay lines (Aesthetics) -->
            <div class="absolute inset-0 pointer-events-none border border-gray-300 opacity-20 z-20"></div>
        </div>

        <!-- Hint -->
        <div id="hint" class="absolute top-4 bg-white/90 p-2 rounded shadow text-gray-600 text-sm animate-pulse pointer-events-none z-30">
            üëÜ Arraste para mover, pince para zoom
        </div>
    </main>

    <!-- CONTROLS & PALETTE -->
    <div class="shrink-0 z-40 flex flex-col bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        
        <!-- Top Controls -->
        <div class="px-4 py-2 flex flex-col gap-2 w-full max-w-md mx-auto">
            
            <!-- Mode Switcher -->
            <div class="flex bg-gray-100 p-1 rounded-lg">
                <button id="mode-build" class="flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-[#003366] shadow-sm">
                    üèóÔ∏è Construir
                </button>
                <button id="mode-risk" class="flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700">
                    ‚ö†Ô∏è Legendar
                </button>
            </div>

            <!-- Action Row -->
            <div class="flex gap-2 justify-between">
                <div class="flex gap-1 bg-white p-1 rounded-lg shadow-sm border border-gray-200">
                    <button id="btn-zoom-out" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-bold text-xl active:bg-gray-300">-</button>
                    <button id="btn-zoom-in" class="w-10 h-10 flex items-center justify-center bg-gray-100 text-gray-700 rounded hover:bg-gray-200 font-bold text-xl active:bg-gray-300">+</button>
                </div>
                <button id="btn-reset" class="flex-1 px-4 h-10 flex items-center justify-center bg-gray-200 text-gray-700 rounded-lg hover:bg-red-100 hover:text-red-700 font-bold text-sm transition-colors active:scale-95">
                    Limpar Tudo
                </button>
            </div>
        </div>

        <!-- Palette (Dynamic Content) -->
        <div class="bg-white border-t-2 border-gray-200 w-full flex flex-col h-56 overflow-hidden">
            <div id="palette-container" class="flex-1 overflow-y-auto p-4 pb-20 palette-scroll">
                
                <!-- BUILD PALETTE -->
                <div id="palette-build" class="block">
                    <div id="build-items-grid"></div>
                </div>

                <!-- RISK PALETTE -->
                <div id="palette-risk" class="hidden">
                    
                    <!-- Size Selector -->
                    <div class="mb-4">
                        <h3 class="text-gray-400 font-bold mb-2 text-xs uppercase tracking-wider">Tamanho do Risco</h3>
                        <div class="flex gap-4 justify-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <button onclick="setRiskSize('small')" class="risk-size-btn w-8 h-8 rounded-full border-2 border-gray-300 bg-gray-200 hover:border-gray-500 transition-all flex items-center justify-center text-[10px]" data-size="small">P</button>
                            <button onclick="setRiskSize('medium')" class="risk-size-btn w-10 h-10 rounded-full border-2 border-gray-300 bg-gray-200 hover:border-gray-500 transition-all flex items-center justify-center text-xs" data-size="medium">M</button>
                            <button onclick="setRiskSize('large')" class="risk-size-btn w-12 h-12 rounded-full border-2 border-[#003366] bg-gray-300 transition-all flex items-center justify-center font-bold" data-size="large">G</button>
                        </div>
                    </div>

                    <!-- Type Selector -->
                    <div id="risk-types-grid" class="grid grid-cols-2 gap-3"></div>
                </div>

            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- CONSTANTS & DATA ---
        const GRID_SIZE = 20;
        const CELL_SIZE = 40;
        
        // Build Items
        const BUILD_ITEMS = [
            { id: 'wall', name: 'Parede', category: 'ESTRUTURA', icon: 'üß±', color: 'bg-gray-700' },
            { id: 'door', name: 'Porta', category: 'ESTRUTURA', icon: 'üö™', color: 'bg-yellow-100' },
            { id: 'window', name: 'Janela', category: 'ESTRUTURA', icon: 'ü™ü', color: 'bg-blue-100' },
            { id: 'bench', name: 'Bancada', category: 'ESTRUTURA', icon: '‚¨ú', color: 'bg-gray-300' },
            { id: 'sink', name: 'Pia', category: 'EQUIPAMENTOS', icon: 'üö∞', color: 'bg-cyan-100' },
            { id: 'fume_hood', name: 'Capela', category: 'EQUIPAMENTOS', icon: 'üí®', color: 'bg-blue-200' },
            { id: 'chair', name: 'Cadeira', category: 'EQUIPAMENTOS', icon: 'ü™ë', color: 'bg-slate-200' },
            { id: 'cabinet', name: 'Arm√°rio', category: 'EQUIPAMENTOS', icon: 'üóÑÔ∏è', color: 'bg-amber-100' },
            { id: 'freezer', name: 'Geladeira', category: 'EQUIPAMENTOS', icon: '‚ùÑÔ∏è', color: 'bg-gray-200' },
            { id: 'trash', name: 'Lixo', category: 'EQUIPAMENTOS', icon: 'üóëÔ∏è', color: 'bg-red-100' },
            { id: 'shower', name: 'Chuveiro', category: 'SEGURAN√áA', icon: 'üöø', color: 'bg-green-100' },
            { id: 'extinguisher', name: 'Extintor', category: 'SEGURAN√áA', icon: 'üßØ', color: 'bg-red-500 text-white' },
        ];

        // Risk Definitions (Cores padronizadas CIPA/NR-5)
        const RISK_TYPES = [
            { id: 'physical', name: 'F√≠sico', color: '#10B981', desc: 'Ru√≠do, Calor, Vibra√ß√£o' }, // Green
            { id: 'chemical', name: 'Qu√≠mico', color: '#EF4444', desc: 'Poeiras, Vapores, L√≠quidos' }, // Red
            { id: 'biological', name: 'Biol√≥gico', color: '#78350F', desc: 'V√≠rus, Bact√©rias' }, // Brown
            { id: 'ergonomic', name: 'Ergon√¥mico', color: '#F59E0B', desc: 'Postura, Esfor√ßo' }, // Yellow
            { id: 'accident', name: 'Acidentes', color: '#3B82F6', desc: 'Arranjo f√≠sico, Quedas' } // Blue
        ];

        // --- STATE ---
        let appState = {
            mode: 'build', // 'build' or 'risk'
            grid: new Array(GRID_SIZE * GRID_SIZE).fill(null), // Building layer
            risks: new Array(GRID_SIZE * GRID_SIZE).fill(null), // Risk layer { type, size }
            
            selectedBuildTool: null, // null = eraser
            selectedRiskType: RISK_TYPES[0],
            selectedRiskSize: 'large', // 'small', 'medium', 'large'
            
            pan: { x: 0, y: 0 },
            zoom: 0.5,
            
            // Interaction
            isDragging: false,
            startX: 0, startY: 0,
            lastTouch: null, lastDist: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            grid: document.getElementById('lab-grid'),
            riskLayer: document.getElementById('risk-layer'),
            transform: document.getElementById('transform-container'),
            main: document.getElementById('main-container'),
            hint: document.getElementById('hint'),
            
            // Palettes
            paletteContainer: document.getElementById('palette-container'),
            buildPalette: document.getElementById('palette-build'),
            riskPalette: document.getElementById('palette-risk'),
            buildGrid: document.getElementById('build-items-grid'),
            riskGrid: document.getElementById('risk-types-grid'),
            
            // Mode Buttons
            btnModeBuild: document.getElementById('mode-build'),
            btnModeRisk: document.getElementById('mode-risk')
        };

        // --- INITIALIZATION ---
        function init() {
            renderGridCells();
            renderBuildPalette();
            renderRiskPalette();
            updateTransform();
            
            // Initial selection
            selectBuildTool('wall'); 
            updateModeUI();

            // Event Listeners
            setupTouchEvents();
            setupMouseEvents();
            setupButtons();
        }

        // --- RENDER LOGIC ---
        function renderGridCells() {
            els.grid.innerHTML = '';
            for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                const div = document.createElement('div');
                div.id = `cell-${i}`;
                div.className = "border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none bg-white hover:bg-blue-50 transition-colors overflow-hidden grid-cell";
                div.onpointerup = (e) => {
                    if (!appState.isDragging) handleCellClick(i);
                };
                els.grid.appendChild(div);
            }
        }

        function renderRiskLayer() {
            els.riskLayer.innerHTML = '';
            appState.risks.forEach((risk, index) => {
                if (!risk) return;
                
                const y = Math.floor(index / GRID_SIZE);
                const x = index % GRID_SIZE;
                
                const circle = document.createElement('div');
                circle.className = `risk-circle risk-${risk.size}`;
                circle.style.backgroundColor = risk.color;
                circle.style.left = `${(x * CELL_SIZE) + (CELL_SIZE/2)}px`;
                circle.style.top = `${(y * CELL_SIZE) + (CELL_SIZE/2)}px`;
                
                els.riskLayer.appendChild(circle);
            });
        }

        function updateGridCell(index) {
            const cell = appState.grid[index];
            const div = document.getElementById(`cell-${index}`);
            if (cell) {
                div.className = `border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none transition-colors overflow-hidden grid-cell ${cell.color}`;
                div.innerText = cell.icon;
            } else {
                div.className = "border border-gray-200 flex items-center justify-center text-xl cursor-pointer select-none bg-white hover:bg-blue-50 transition-colors overflow-hidden grid-cell";
                div.innerText = '';
            }
            // Check for hint
            const isEmpty = appState.grid.every(c => c === null);
            els.hint.style.display = isEmpty ? 'block' : 'none';
        }

        function renderBuildPalette() {
            // Eraser
            const eraserDiv = document.createElement('div');
            eraserDiv.className = 'mb-4';
            eraserDiv.innerHTML = `
                <button onclick="selectBuildTool(null)" id="tool-eraser" class="w-full flex items-center gap-3 p-3 rounded-lg border-2 border-gray-200 bg-gray-50 hover:bg-gray-100 transition-all">
                    <span class="text-2xl">üßπ</span>
                    <div class="text-left"><p class="font-bold text-gray-800">Borracha</p><p class="text-xs text-gray-500">Limpar c√©lula</p></div>
                </button>
            `;
            els.buildGrid.parentNode.insertBefore(eraserDiv, els.buildGrid);

            // Categories
            const categories = [...new Set(BUILD_ITEMS.map(i => i.category))];
            categories.forEach(cat => {
                const header = document.createElement('h3');
                header.className = "text-gray-400 font-bold mb-2 text-xs uppercase tracking-wider mt-2";
                header.innerText = cat;
                els.buildGrid.appendChild(header);

                const grid = document.createElement('div');
                grid.className = "grid grid-cols-2 gap-3 mb-2";
                
                BUILD_ITEMS.filter(i => i.category === cat).forEach(item => {
                    const btn = document.createElement('button');
                    btn.id = `tool-${item.id}`;
                    btn.className = "build-btn flex flex-col items-center p-3 rounded-lg border-2 border-gray-100 bg-white hover:border-gray-300 shadow-sm transition-all active:scale-95";
                    btn.innerHTML = `<span class="text-3xl mb-1">${item.icon}</span><span class="text-sm font-semibold text-gray-700">${item.name}</span>`;
                    btn.onclick = () => selectBuildTool(item.id);
                    grid.appendChild(btn);
                });
                els.buildGrid.appendChild(grid);
            });
        }

        function renderRiskPalette() {
             // Eraser for Risks
            const eraserDiv = document.createElement('div');
            eraserDiv.className = 'mb-4';
            eraserDiv.innerHTML = `
                <button onclick="selectRiskType(null)" id="risk-eraser" class="w-full flex items-center gap-3 p-3 rounded-lg border-2 border-gray-200 bg-gray-50 hover:bg-gray-100 transition-all">
                    <span class="text-2xl">üßπ</span>
                    <div class="text-left"><p class="font-bold text-gray-800">Borracha de Risco</p><p class="text-xs text-gray-500">Remover legenda</p></div>
                </button>
            `;
            els.riskGrid.parentNode.insertBefore(eraserDiv, els.riskGrid.parentNode.firstChild.nextSibling);

            RISK_TYPES.forEach(type => {
                const btn = document.createElement('button');
                btn.id = `risk-btn-${type.id}`;
                // Using inline style for dynamic border color on hover/active could be complex, keeping simple classes
                btn.className = "risk-type-btn flex flex-col p-3 rounded-lg border-2 border-gray-100 bg-white shadow-sm transition-all active:scale-95 text-left";
                btn.onclick = () => selectRiskType(type);
                
                btn.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        <div class="w-4 h-4 rounded-full" style="background-color: ${type.color}"></div>
                        <span class="font-bold text-sm text-gray-800">${type.name}</span>
                    </div>
                    <span class="text-[10px] text-gray-500 leading-tight">${type.desc}</span>
                `;
                els.riskGrid.appendChild(btn);
            });
            
            // Select default
            selectRiskType(RISK_TYPES[0]);
        }

        // --- STATE MANAGEMENT ---

        // MODE SWITCHING
        function setMode(mode) {
            appState.mode = mode;
            updateModeUI();
        }

        function updateModeUI() {
            if (appState.mode === 'build') {
                els.btnModeBuild.className = "flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-[#003366] shadow-md ring-1 ring-gray-200";
                els.btnModeRisk.className = "flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700";
                els.buildPalette.classList.remove('hidden');
                els.riskPalette.classList.add('hidden');
                // Visual cue on grid
                els.grid.classList.remove('opacity-50');
                els.riskLayer.classList.add('opacity-50'); // Dim risks while building
            } else {
                els.btnModeRisk.className = "flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-[#FF8C00] shadow-md ring-1 ring-gray-200";
                els.btnModeBuild.className = "flex-1 py-2 rounded-md text-sm font-bold transition-all text-gray-500 hover:text-gray-700";
                els.buildPalette.classList.add('hidden');
                els.riskPalette.classList.remove('hidden');
                // Visual cue
                els.grid.classList.add('opacity-50'); // Dim build items
                els.riskLayer.classList.remove('opacity-50');
            }
        }

        // SELECTION LOGIC
        window.selectBuildTool = (id) => {
            appState.selectedBuildTool = id;
            document.querySelectorAll('.build-btn').forEach(b => b.classList.remove('border-[#003366]', 'bg-blue-50', 'ring-2', 'ring-blue-200'));
            document.getElementById('tool-eraser').classList.remove('border-[#FF8C00]', 'bg-orange-50');
            
            if (id === null) {
                document.getElementById('tool-eraser').classList.add('border-[#FF8C00]', 'bg-orange-50');
            } else {
                const btn = document.getElementById(`tool-${id}`);
                if (btn) btn.classList.add('border-[#003366]', 'bg-blue-50', 'ring-2', 'ring-blue-200');
            }
        };

        window.setRiskSize = (size) => {
            appState.selectedRiskSize = size;
            document.querySelectorAll('.risk-size-btn').forEach(b => {
                b.classList.remove('border-[#003366]', 'border-2');
                b.classList.add('border-gray-300');
            });
            const activeBtn = document.querySelector(`.risk-size-btn[data-size="${size}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('border-gray-300');
                activeBtn.classList.add('border-[#003366]', 'border-2');
            }
        };

        window.selectRiskType = (typeObjOrNull) => {
            appState.selectedRiskType = typeObjOrNull;
            document.querySelectorAll('.risk-type-btn').forEach(b => b.classList.remove('ring-2', 'ring-offset-1'));
            document.getElementById('risk-eraser').classList.remove('border-[#FF8C00]', 'bg-orange-50');

            if (typeObjOrNull === null) {
                 document.getElementById('risk-eraser').classList.add('border-[#FF8C00]', 'bg-orange-50');
            } else {
                const btn = document.getElementById(`risk-btn-${typeObjOrNull.id}`);
                if (btn) {
                    btn.classList.add('ring-2', 'ring-offset-1');
                    btn.style.borderColor = typeObjOrNull.color;
                }
            }
        };

        // INTERACTION HANDLERS
        function handleCellClick(index) {
            if (appState.mode === 'build') {
                if (appState.selectedBuildTool === null) {
                    appState.grid[index] = null;
                } else {
                    const item = BUILD_ITEMS.find(i => i.id === appState.selectedBuildTool);
                    appState.grid[index] = item;
                }
                updateGridCell(index);
            } else {
                // Risk Mode
                if (appState.selectedRiskType === null) {
                    appState.risks[index] = null;
                } else {
                    appState.risks[index] = {
                        typeId: appState.selectedRiskType.id,
                        color: appState.selectedRiskType.color,
                        size: appState.selectedRiskSize
                    };
                }
                renderRiskLayer();
            }
        }

        function handleDownload() {
            // Save current view state
            const prevZoom = appState.zoom;
            const prevPan = { ...appState.pan };
            const prevOpacityGrid = els.grid.classList.contains('opacity-50');
            const prevOpacityRisk = els.riskLayer.classList.contains('opacity-50');

            // Reset for capture
            appState.zoom = 1;
            appState.pan = { x: 0, y: 0 };
            els.grid.classList.remove('opacity-50');
            els.riskLayer.classList.remove('opacity-50');
            updateTransform();

            const target = document.getElementById('transform-container');
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Gerando...';

            html2canvas(target, {
                scale: 2, // Better resolution
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'meu-mapa-de-risco.png';
                link.href = canvas.toDataURL();
                link.click();
                
                // Restore state
                appState.zoom = prevZoom;
                appState.pan = prevPan;
                if (prevOpacityGrid) els.grid.classList.add('opacity-50');
                if (prevOpacityRisk) els.riskLayer.classList.add('opacity-50');
                updateTransform();
                btn.innerHTML = originalText;
            }).catch(err => {
                console.error(err);
                alert("Erro ao baixar imagem. Tente novamente.");
                btn.innerHTML = originalText;
            });
        }

        function handleReset() {
            if (confirm('Tem certeza que deseja apagar TODO o mapa e recome√ßar do zero?')) {
                // 1. Reset Arrays
                appState.grid = new Array(GRID_SIZE * GRID_SIZE).fill(null);
                appState.risks = new Array(GRID_SIZE * GRID_SIZE).fill(null);

                // 2. Full Re-render to clear DOM ghosts
                renderGridCells();
                renderRiskLayer();

                // 3. Reset View Properties
                appState.pan = { x: 0, y: 0 };
                appState.zoom = 0.5;
                updateTransform();

                // 4. Update UI state (hide hints if necessary, though empty grid shows hint)
                els.hint.style.display = 'block';
                
                // 5. Visual Feedback
                els.transform.classList.add('shake-animation');
                setTimeout(() => els.transform.classList.remove('shake-animation'), 500);
            }
        }

        // --- NAVIGATION & UTILS ---
        function updateTransform() {
            els.transform.style.transform = `translate(${appState.pan.x}px, ${appState.pan.y}px) scale(${appState.zoom})`;
        }

        function setupButtons() {
            els.btnModeBuild.onclick = () => setMode('build');
            els.btnModeRisk.onclick = () => setMode('risk');
            
            document.getElementById('btn-zoom-in').onclick = () => { appState.zoom = Math.min(appState.zoom + 0.1, 2.5); updateTransform(); };
            document.getElementById('btn-zoom-out').onclick = () => { appState.zoom = Math.max(appState.zoom - 0.1, 0.2); updateTransform(); };
            
            // Explicitly bind Reset button
            const btnReset = document.getElementById('btn-reset');
            if(btnReset) {
                btnReset.onclick = handleReset;
            }

            document.getElementById('btn-download').onclick = handleDownload;
        }

        function setupTouchEvents() {
             els.main.addEventListener('touchstart', (e) => {
                appState.isDragging = false;
                if (e.touches.length === 1) {
                    appState.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                } else if (e.touches.length === 2) {
                    appState.lastDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                }
            }, { passive: false });

            els.main.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && appState.lastTouch) {
                    const dx = e.touches[0].clientX - appState.lastTouch.x;
                    const dy = e.touches[0].clientY - appState.lastTouch.y;
                    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) appState.isDragging = true;
                    appState.pan.x += dx;
                    appState.pan.y += dy;
                    appState.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    updateTransform();
                } else if (e.touches.length === 2 && appState.lastDist) {
                    const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const scaleFactor = newDist / appState.lastDist;
                    appState.zoom = Math.min(Math.max(appState.zoom * scaleFactor, 0.2), 3.0);
                    appState.lastDist = newDist;
                    appState.isDragging = true;
                    updateTransform();
                }
            }, { passive: false });

            els.main.addEventListener('touchend', () => {
                appState.lastTouch = null;
                appState.lastDist = null;
            });
        }

        function setupMouseEvents() {
            els.main.addEventListener('mousedown', (e) => {
                appState.isDragging = false;
                appState.startX = e.clientX;
                appState.startY = e.clientY;
                els.main.style.cursor = 'grabbing';
                
                const onMouseMove = (ev) => {
                    const dx = ev.clientX - appState.startX;
                    const dy = ev.clientY - appState.startY;
                    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) appState.isDragging = true;
                    appState.pan.x += dx;
                    appState.pan.y += dy;
                    appState.startX = ev.clientX;
                    appState.startY = ev.clientY;
                    updateTransform();
                };
                
                const onMouseUp = () => {
                    els.main.removeEventListener('mousemove', onMouseMove);
                    els.main.removeEventListener('mouseup', onMouseUp);
                    els.main.style.cursor = 'grab';
                };
                
                els.main.addEventListener('mousemove', onMouseMove);
                els.main.addEventListener('mouseup', onMouseUp);
            });
        }

        // Start
        init();
    </script>
</body>
</html>
